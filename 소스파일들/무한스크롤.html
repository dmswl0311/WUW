<!DOCTYPE html>
<html>
    <head>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.min.js"></script>
        <script src="https://rawgit.com/davidchin/angular-endless-scroll/master/dist/angular-endless-scroll.js"></script>

    </head>
    <body>
        <section ng-app="Demo" ng-cloak class="container">
                <div ng-controller="MainController">
                    <p class="text-center">
                    Posts from <a href="https://fuckyeahcats.tumblr.com">https://fuckyeahcats.tumblr.com</a>
                    </p>
                
                    <div class="row">
                    <div endless-scroll="post in posts" class="col-md-4">
                        <a ng-href="{{ post.post_url }}" class="thumbnail">
                        <div ng-style="{ 'background-image': 'url(' + post.photos[0].alt_sizes[3].url + ')' }" class="image"></div>
                        <div class="caption text-center">
                            <span ng-show="post.post_author">
                            {{ post.post_author }}
                            </span>
                            <span ng-hide="post.post_author">
                            N/A
                            </span>
                        </div>
                        </a>
                    </div>
                    </div>
                
                    <p ng-show="pagination.totalPages" class="text-center text-muted">
                    <span ng-show="loading">
                        Loading...
                    </span>
                    {{ pagination.lastPage }} / {{ pagination.totalPages }}
                    </p>
                </div>
                </section>


                <style>
                    [ng-cloak] {
                        display: none;
                        }
                        
                        .container {
                        padding-top: 30px;
                        padding-bottom: 30px;
                        max-width: 750px;
                        }
                        
                        .thumbnail .caption {
                        font-size: 13px;
                        font-weight: normal;
                        white-space: nowrap;
                        text-overflow: ellipsis;
                        overflow: hidden;
                        }
                        .thumbnail .image {
                        height: 210px;
                        background-position: 50% 50%;
                        background-size: 100%;
                        background-repeat: no-repeat;
                        background-color: #000;
                        }
                          
                </style>

                <script>
                    (function(angular) {
                        'use strict';
                        
                        // Module
                        angular.module('Demo', ['dc.endlessScroll']);
                        
                        // Config
                        angular.module('Demo')
                            .config(function($locationProvider) {
                            $locationProvider.html5Mode(true);
                            });
                        
                        // Service
                        angular.module('Demo')
                            .factory('PostLoader', function($http, $q) {
                            function PostLoader() {}
                        
                            PostLoader.prototype.init = function(params) {
                                params = angular.extend({ page: 1 }, params);
                        
                                // Properties
                                this.pagination = { perPage: 20, maxPages: 50 };
                                this.posts = [];
                        
                                // Load the initial page, using the URL param if available
                                return this.load(params.page);
                            };
                        
                            PostLoader.prototype.load = function(page) {
                                page = parseInt(page, 10);
                                page = isNaN(page) ? 1 : page;
                        
                                var method = this.pagination.lastPage && page < this.pagination.lastPage ? 'unshift' : 'push';
                        
                                // Define the current page
                                if (this.pagination.totalPages) {
                                page = Math.min(Math.max(page, 1), this.pagination.totalPages);
                                }
                        
                                // Only load a new page if it is not already loaded
                                if ((page > this.pagination.lastPage || !this.pagination.lastPage) ||
                                    (page < this.pagination.firstPage || !this.pagination.firstPage)) {
                                return this.get(page)
                                    .success(angular.bind(this, function(data) {
                                    var response = data.response;
                        
                                    // Set the last page
                                    if (!this.pagination.lastPage || page > this.pagination.lastPage) {
                                        this.pagination.lastPage = page;
                                    }
                        
                                    // Set the first page, if not already set
                                    if (!this.pagination.firstPage || page < this.pagination.firstPage) {
                                        this.pagination.firstPage = page;
                                    }
                        
                                    // Determine the total number of pages
                                    this.pagination.totalPages = Math.ceil(response.total_posts / this.pagination.perPage);
                        
                                    if (this.pagination.maxPages) {
                                        this.pagination.totalPages = Math.min(this.pagination.totalPages, this.pagination.maxPages);
                                    }
                        
                                    // Append or prepend the fetched posts, depending if they are posts from the next or previous page
                                    this.posts[method].apply(this.posts, response.posts);
                        
                                    // Return the array of posts
                                    return response.posts;
                                    }));
                                } else {
                                return $q.reject();
                                }
                            };
                        
                            PostLoader.prototype.next = function() {
                                var page = !this.pagination.lastPage ? 1 : this.pagination.lastPage + 1;
                        
                                // Get the next page
                                return this.load(page);
                            };
                        
                            PostLoader.prototype.previous = function() {
                                var page = !this.pagination.firstPage ? 1 : this.pagination.firstPage - 1;
                        
                                // Get the previous page
                                return this.load(page);
                            };
                        
                            PostLoader.prototype.get = function(page) {
                                var url = 'https://api.tumblr.com/v2/blog/fuckyeahcats.tumblr.com/posts/photo',
                                    config = {
                                    params: {
                                        api_key: 'z46iUTiovIf3N5KdioKhU2vvTBMWRHA8KLeIBruDnEHTXpiK8n',
                                        jsonp: 'JSON_CALLBACK',
                                        limit: this.pagination.perPage
                                    }
                                    };
                        
                                // Define the post number to start from
                                config.params.offset = (page - 1) * config.params.limit;
                        
                                // Make a HTTP request
                                return $http.jsonp(url, config);
                            };
                        
                            return {
                                create: function() {
                                return new PostLoader();
                                }
                            };
                            });
                        
                        // Controller
                        angular.module('Demo')
                            .controller('MainController', function($scope, $location, PostLoader) {
                            // Private vars
                            var postLoader = PostLoader.create();
                        
                            // Private methods
                            function onPageLoad() {
                                $scope.posts = postLoader.posts;
                                $scope.pagination = postLoader.pagination;
                                $scope.loading = false;
                            }
                        
                            function onPageLoadError() {
                                $scope.loading = false;
                            }
                        
                            // Scope methods
                            $scope.nextPage = function() {
                                $scope.loading = true;
                        
                                postLoader.next().then(onPageLoad, onPageLoadError);
                            };
                        
                            $scope.previousPage = function() {
                                $scope.loading = true;
                        
                                postLoader.previous().then(onPageLoad, onPageLoadError);
                            };
                        
                            // Register event handlers
                            $scope.$on('endlessScroll:next', $scope.nextPage);
                            $scope.$on('endlessScroll:previous', $scope.previousPage);
                        
                            // Initialise
                            var params = {
                                page: $location.search().page
                            };
                        
                            postLoader.init(params).then(onPageLoad);
                            });
                        })(window.angular);
                </script>
    </body>
</html>